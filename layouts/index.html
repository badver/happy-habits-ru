<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting...</title>

  <!-- SEO: Router page should not be indexed -->
  <meta name="robots" content="noindex,nofollow">
  <link rel="canonical" href="{{ .Site.BaseURL }}v/a/">

  <!-- Minimal styling for brief flash -->
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f8f9fa;
      color: #666;
    }
  </style>

  {{ if .Site.Params.yandexMetrikaID }}
  <!-- Yandex.Metrika counter (for tracking router visits) -->
  <script type="text/javascript">
    (function (m, e, t, r, i, k, a) {
      m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
      m[i].l = 1 * new Date();
      for (var j = 0; j < document.scripts.length; j++) { if (document.scripts[j].src === r) { return; } }
      k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
    })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym');

    ym({{ .Site.Params.yandexMetrikaID }}, 'init', {
      webvisor: true,
      clickmap: true,
      accurateTrackBounce: true,
      trackLinks: true
    });
  </script>
  {{ end }}

  {{ if .Site.Params.googleAnalyticsID }}
  <!-- Google Analytics 4 (for tracking router visits) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.googleAnalyticsID }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', '{{ .Site.Params.googleAnalyticsID }}');
  </script>
  {{ end }}

  <!-- Router script (inline for immediate execution) -->
  <script>
    (function() {
      'use strict';

      var STORAGE_KEY = 'landing_variant';
      var config = {
        variants: {{ .Site.Params.variants.list | default (slice "a") | jsonify | safeJS }},
        weights: {{ .Site.Params.variants.weights | default (slice 100) | jsonify | safeJS }},
        defaultVariant: {{ .Site.Params.variants.default | default "a" | jsonify | safeJS }},
        forceParam: {{ .Site.Params.variants.forceParam | default "v" | jsonify | safeJS }},
        enabled: {{ if .Site.Params.variants.enabled }}true{{ else }}false{{ end }},
        yandexMetrikaID: {{ .Site.Params.yandexMetrikaID | default 0 }},
        googleAnalyticsID: {{ .Site.Params.googleAnalyticsID | default "" | jsonify | safeJS }}
      };

      function weightedRandom(variants, weights) {
        var total = 0;
        for (var i = 0; i < weights.length; i++) total += weights[i];
        var rand = Math.random() * total;
        var cumulative = 0;
        for (var j = 0; j < variants.length; j++) {
          cumulative += weights[j];
          if (rand < cumulative) return variants[j];
        }
        return variants[variants.length - 1];
      }

      function getUrlParam(param) {
        var params = new URLSearchParams(window.location.search);
        return params.get(param);
      }

      function isValidVariant(v) {
        return v && config.variants.indexOf(v) !== -1;
      }

      function trackAssignment(variant, source) {
        if (config.googleAnalyticsID && typeof gtag === 'function') {
          gtag('event', 'variant_assigned', {
            variant: variant,
            assignment_source: source,
            event_category: 'ab_test'
          });
        }
        if (config.yandexMetrikaID && typeof ym === 'function') {
          ym(config.yandexMetrikaID, 'params', { landing_variant: variant });
          ym(config.yandexMetrikaID, 'reachGoal', 'variant_assigned', { variant: variant });
        }
      }

      function redirect(variant) {
        var url = '/v/' + variant + '/';
        var params = new URLSearchParams(window.location.search);
        params.delete(config.forceParam);
        var qs = params.toString();
        if (qs) url += '?' + qs;
        if (window.location.hash) url += window.location.hash;
        window.location.replace(url);
      }

      // Main router logic
      (function route() {
        if (!config.enabled) {
          redirect(config.defaultVariant);
          return;
        }

        var variant, source;

        // 1. Check URL force parameter
        var forced = getUrlParam(config.forceParam);
        if (isValidVariant(forced)) {
          variant = forced;
          source = 'forced';
          try { localStorage.setItem(STORAGE_KEY, variant); } catch(e) {}
          trackAssignment(variant, source);
          redirect(variant);
          return;
        }

        // 2. Check localStorage
        try {
          var stored = localStorage.getItem(STORAGE_KEY);
          if (isValidVariant(stored)) {
            variant = stored;
            source = 'stored';
            trackAssignment(variant, source);
            redirect(variant);
            return;
          }
        } catch(e) {}

        // 3. Random assignment
        variant = weightedRandom(config.variants, config.weights);
        source = 'assigned';
        try { localStorage.setItem(STORAGE_KEY, variant); } catch(e) {}
        trackAssignment(variant, source);
        redirect(variant);
      })();
    })();
  </script>
</head>
<body>
  <!-- Fallback for no-JS users -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=/v/a/">
    <p>Redirecting to <a href="/v/a/">main page</a>...</p>
  </noscript>

  <!-- Brief loading state (JS will redirect immediately) -->
  <div id="loading">Загрузка...</div>
</body>
</html>
